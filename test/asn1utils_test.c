#include <memory.h>
#include <stdio.h>
#include <stdlib.h>
#include<mbedtls/asn1.h>
#include<mbedtls/asn1write.h>
#include<mbedtls/bignum.h>
#include "wbcrypto/internal/asn1_utils.h"
#include "hex_utils.h"

const char* TEST_CASE1 = "AD346C60C4975FEB0200FD687C658E1E577DB9B0C13153820D5759F3C8F379B5A01ED3C0C7D046C922A9A640966E4FAA5683522A81DC9E0BBBF920D1A9EA459D8497F5E406F476A25D850EB3DEF740AD24B6A01ABDFA32CAE87355BA98F940695ECA19968776DA490A7E501337430C4D462BFA4411E912F4D72A5FD26E58A7503013E63C401DD435ABCE65310F73097FC5DAD9A13E99F7BAB5294D53E4AC3690E77CD811ABC85F009A4FE62683C181C53BE3A59ED1CCF33382572D5C981BDB099E368605712C493E096FEADD454701FD3EA4BEA3710BFB1A4C4C84757B6BF3DE0B454DBB2FB4EAAD0748FCE965CBCF7301BDCEF33A49FB94DB4721D3059FC4EC";
const char* TEST_CASE2 = "2F6E5E6E4899DEA92E458224D55BCECFC1167491241778643BEE3173CC2B23C9E86731669DDF2FF460C4DE0C367E39BEABE6DC0C579A705E7F5A16B6E733DD8A2537C1213E374F26EC95F72CD411A82B9BE63D9A2F485FEB27CFEA5151271EC7934CD471A1564C24AAE00D99714180BDC8AB0E3BF61218141B3676018A8F144261ADEE993536C426D6AAE9B13908F0A2EFD8B42FF1C661E279746B1015850CACA47703941EC64270EDC69781449B74D1E387C53603D74CDF35B406B16BFB20820D3935AB5715481FB0369480D3577F3790C13533ED4E4E09233244C93F11631B6A9C027343E75A6C6326C0B6E4C2CAEE8C9724D95736940EAC43715B72BAC33A";

//to validate a fix of insidious bug in mpi_buflength
int mpi_test_value(const char* value) {
	int ret = 0;
	const char buf[1024];
	const char* p = buf + sizeof(buf);
	mbedtls_mpi v;
	size_t expected, actual;
	mbedtls_mpi_init(&v);
	MBEDTLS_MPI_CHK(mbedtls_mpi_read_string(&v, 16, value));

	mbedtls_asn1_write_mpi(&p, buf, &v);
	expected = (buf + sizeof(buf)) - p;

	actual = wbcrypto_asn1_mpi_buflength(&v);

	if(actual!=expected) {
		return -1;
	}

cleanup:
	mbedtls_mpi_free(&v);
	return ret;
}

int mpi_buflength_regression() {
	int ret = 0;
	MBEDTLS_MPI_CHK(mpi_test_value(TEST_CASE1));
	MBEDTLS_MPI_CHK(mpi_test_value(TEST_CASE2));
cleanup:
	return ret;
}

int main() {
	int ret = 0;
	MBEDTLS_MPI_CHK(mpi_buflength_regression());
cleanup:
	return ret;
}